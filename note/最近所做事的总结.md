## 最近所做的事的总结

最近做了一个动态的接口权限分配的模块（基于Shrio 和 Rose），下面进行下总结。

### 需求
1、 动态的分配角色给用户。
2、 动态的配置角色能访问的接口。
3、 动态的添加、修改角色。
4、 动态的添加、修改接口。
5、 动态导入项目中所有的接口地址。

### 前提了解
1、Shiro大致运行原理，以便于利用Shiro现有的功能。
2、Rose启动过程原理，以及扫描Controller的实现。
3、Vue的大致用法，后台管理界面展示用。
4、Filter的生命周期、配置和启动、响应的顺序。

### 总结
#### Shiro相关
Shiro是一个权限框架，核心是认证、授权、加密、会话管理、与Web集成、缓存等（后续深入了解下其Subject识别，Session管理的实现）。

Shiro的Web实现是通过Filter实现的。在Web容器中添加一个Filter对所有的请求进行拦截，然后根据请求信息**识别用户（Subject）**，然后进行请求地址匹配（**Ant风格** 的配置，Shiro有Ant匹配的实现，可以深入学习下该源码。其中发现一个有意思的类，平时很少用，少见，功能类似 String.split()，叫 **StringTokenizer**，后续深入了解下）。匹配成功则取得该地址对应的FilterChain，然后依次执行里面的Filter。不在配置名单的地址直接交给下面的Filter或Servlet处理。

Shiro的Web实现的核心类：ShiroFilterFactoryBean，PathMatchingFilterChainResolver，DefaultFilterChainManager，DelegatingFilterProxy（这个类是一个代理的Filter类，具体的功能托管给真正的Filter处理。通过这样的方式可以将自己实现的Filter交由Spring控制，然后DelegatingFilterProxy类去Spring容器（ApplicationContext）中找到和Web.xml中配置DelegatingFilterProxy时用的FilterName相同名字的Bean，具体功能就调用该Bean处理。Spring容器的实例ApplicationContext 在ServletContext中，默认键值名是WebApplicationContext.class.getName() + ".ROOT"，即WebApplicationContext.ROOT）。

在这期间了解到Spring的注入，XML配置，接口，工厂注入，工厂接口等方面。还遇到一个莫名的BUG，当我在配置文件中注册一个Bean后，这个Bean里又有注解注入其他的Bean（如用@Autowired），配置文件中又配置了 MethodInvokingFactoryBean的话，这个Bean里的注解不会被处理。（原因未找到，估计和Rose使用的Spring版本较低有关）。实现的Shiro用的Filter要进行错误返回的话，就不会进入Rose，需要自己写返回信息，这里直接通过response返回。

#### Rose相关
由于需要导入项目中的接口，所以需要了解Rose的启动过程和扫描过程。看启动过程中，是否将扫描好的路径树是否放到了Spring容器中了（SpringMVC就将扫描好了的路径树放在容器中的，直接注入就能拿到 T^T）。结果是没有，Rose启动时，将applicationContext.xml中的Bean、Service和Dao层的Bean扫描进RoseWebAppContext中。而项目中每一个controllers包作为一个模块创建一个ModuleAppContext，将每个包下的controller放入对应ModuleAppContext的容器里。而Rose里用到的路径映射树的对象 MappingNode 仅仅引用容器里的Controller Bean。并未将构造好的mappingTree放入容器，直接拿就没办法了。幸好能够从ServletContext中拿到ModuleAppContext，context中有已扫描到的Controller的Class 对象，所以可以通过反射拿到所有的请求地址。 还有个办法则是Rose的请求能够让Controller拿到一个Rose对象，Rose对象里可以拿到MappingTree。

期间还实现了用URL路径构建一个路径树。用于前端树结构返回。HashSet、TreeSet、TreeMap的区别。实现了equals，最好重写hashCode。TreeMap通过红黑树实现，比较的时候用equals。String的hashCode： 设字符串长度为 n，每个位置的字符是 S[i] 0 ≤ i ≤ n，则 Σ S[i] * 31^(n - i - 1)

#### 页面显示相关
前端显示找了一个模板，采用纯静态页面写，用到了vue.js，一个JS模板引擎。在Vue官网可以深入了解，后续可以加上 node.js webpack 等学习。