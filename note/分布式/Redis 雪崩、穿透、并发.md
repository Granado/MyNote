## **缓存雪崩**

数据未加载到缓存中，或者缓存同一时间大面积的失效，从而导致所有请求都去查数据库，导致数据库 CPU 和内存负载过高，甚至宕机。

**比如一个雪崩的简单过程：**

1、redis 集群大面积故障

2、缓存失效，但依然大量请求访问缓存服务 redis

3、redis 大量失效后，大量请求转向到 mysql 数据库

4、mysql 的调用量暴增，很快就扛不住了，甚至直接宕机

5、由于大量的应用服务依赖 mysql 和 redis 的服务，这个时候很快会演变成各服务器集群的雪崩，最后网站彻底崩溃。

![](https://pic2.zhimg.com/v2-cf0176503a1b5c51ff56d466de94060d_b.jpg)![](https://pic2.zhimg.com/80/v2-cf0176503a1b5c51ff56d466de94060d_hd.jpg)

## **如何预防缓存雪崩：**

![](https://pic4.zhimg.com/v2-38801b551891fb0b0dc4e6414b41c52b_b.jpg)![](https://pic4.zhimg.com/80/v2-38801b551891fb0b0dc4e6414b41c52b_hd.jpg)

**1\. 缓存的高可用性**

缓存层设计成高可用，防止缓存大面积故障。即使个别节点、个别机器、甚至是机房宕掉，依然可以提供服务，例如 Redis Sentinel 和 Redis Cluster 都实现了高可用。

**2\. 缓存降级**

可以利用 ehcache 等本地缓存 (暂时支持)，但主要还是对源服务访问进行限流、资源隔离（熔断）、降级等。

当访问量剧增、服务出现问题仍然需要保证服务还是可用的。系统可以根据一些关键数据进行**自动降级**，也可以配置开关实现**人工降级，**这里会涉及到运维的配合。

**降级的最终目的是保证核心服务可用，即使是有损的。**

比如推荐服务中，很多都是个性化的需求，假如个性化需求不能提供服务了，可以降级补充热点数据，不至于造成前端页面是个大空白。

在进行降级之前要对系统进行梳理，比如：哪些业务是核心 (必须保证)，哪些业务可以容许暂时不提供服务(利用静态页面替换) 等，以及配合服务器核心指标，来后设置整体预案，比如：

（1）一般：比如有些服务偶尔因为网络抖动或者服务正在上线而超时，可以自动降级；

（2）警告：有些服务在一段时间内成功率有波动（如在 95~100% 之间），可以自动降级或人工降级，并发送告警；

（3）错误：比如可用率低于 90%，或者数据库连接池被打爆了，或者访问量突然猛增到系统能承受的最大阀值，此时可以根据情况自动降级或者人工降级；

（4）严重错误：比如因为特殊原因数据错误了，此时需要紧急人工降级。

**3.Redis 备份和快速预热**

1)Redis 数据备份和恢复

2) 快速缓存预热

**4\. 提前演练**

最后，建议还是在项目上线前，演练缓存层宕掉后，应用以及后端的负载情况以及可能出现的问题，对高可用提前预演，提前发现问题。

## **缓存穿透**

缓存穿透是指查询一个一不存在的数据。例如：从缓存 redis 没有命中，需要从 mysql 数据库查询，查不到数据则不写入缓存，这将导致这个不存在的数据每次请求都要到数据库去查询，造成缓存穿透。

解决思路：

如果查询数据库也为空，直接设置一个默认值存放到缓存，这样第二次到缓冲中获取就有值了，而不会继续访问数据库。设置一个过期时间或者当有值的时候将缓存中的值替换掉即可。

可以给 key 设置一些格式规则，然后查询之前先过滤掉不符合规则的 Key。

## **缓存并发**

这里的并发指的是多个 redis 的 client 同时 set key 引起的并发问题。其实 redis 自身就是单线程操作，多个 client 并发操作，按照先到先执行的原则，先到的先执行，其余的阻塞。当然，另外的解决方案是把 redis.set 操作放在队列中使其串行化，必须的一个一个执行。

## **缓存预热**

缓存预热就是系统上线后，将相关的缓存数据直接加载到缓存系统。

这样就可以避免在用户请求的时候，先查询数据库，然后再将数据缓存的问题！用户直接查询事先被预热的缓存数据！

解决思路：

1、直接写个缓存刷新页面，上线时手工操作下；

2、数据量不大，可以在项目启动的时候自动进行加载；

目的就是在系统上线前，将数据加载到缓存中。

以上就是缓存雪崩、预热、降级等的介绍。

觉得不错请点赞支持下。

----end----

优知学院往期分享的 Redis 精选干货，感兴趣不妨深入了解，让你知其然更知其所以然，深度掌握 Redis。

[Redis 缓存和 MySQL 数据一致性方案详解](https://zhuanlan.zhihu.com/p/58536781)

[Redis 并发竞争 key 的解决方案详解](https://zhuanlan.zhihu.com/p/52756935)

[Redis 为什么是单线程，高并发快的 3 大原因详解](https://zhuanlan.zhihu.com/p/58038188)

[Redis 面试题目 49 道附答案](https://zhuanlan.zhihu.com/p/58333436)